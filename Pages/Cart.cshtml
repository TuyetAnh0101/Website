@page
@model CartModel
@using SportsStore.Models

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

<style>
    .cart-title {
        font-size: 24px;
        font-weight: 600;
        color: #1e8141;
        margin: 20px 0 15px;
    }

    .product-img {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 6px;
        border: 1px solid #ccc;
    }

    .product-name {
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 5px;
    }

    .cart-item {
        border: 1px solid #eee;
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 15px;
        background: #fff;
    }

    .qty-box {
        width: 60px;
        text-align: center;
        font-weight: bold;
    }

    .cart-summary {
        background: #f8f9fa;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
    }

    .btn-action {
        font-size: 14px;
        padding: 10px 20px;
        border-radius: 6px;
    }

    .btn-update {
        background-color: #34a853;
        color: #fff;
    }

    .btn-checkout {
        background-color: #1e8141;
        color: #fff;
    }

    .btn-checkout:hover {
        background-color: #166b36;
    }
</style>

<div class="container">
    <h2 class="cart-title text-center">üõí GI·ªé H√ÄNG C·ª¶A B·∫†N</h2>

    <div class="row">
        <div class="col-lg-8">
            @foreach (var line in Model?.Cart?.Lines ?? Enumerable.Empty<CartLine>())
            {
                <div class="cart-item d-flex justify-content-between align-items-center flex-wrap">
                    <div class="d-flex align-items-center flex-grow-1 gap-3">
                        <img src="/images/@(string.IsNullOrEmpty(line.Product.Image) ? "default.jpg" : line.Product.Image)"
                             class="product-img" alt="@line.Product.Name" />
                        <div>
                            <div class="product-name">@line.Product.Name</div>
                            <div class="small text-muted">@(line.IsRental ? $"Thu√™ {line.RentalDays} ng√†y" : "Mua")</div>
                            <form method="post" asp-page-handler="Remove" class="mt-1">
                                <input type="hidden" name="ProductID" value="@line.Product.ProductID" />
                                <input type="hidden" name="isRental" value="@line.IsRental" />
                                <input type="hidden" name="returnUrl" value="@Model?.ReturnUrl" />
                                <button type="submit" class="btn btn-link p-0 text-danger small">X√≥a</button>
                            </form>
                        </div>
                    </div>

                    <div class="text-end">
                        <div class="fw-bold text-danger mb-2">@line.LineTotal.ToString("N0") ƒë</div>
                        <input type="number" class="form-control qty-box mx-auto" value="@line.Quantity" readonly />
                    </div>
                </div>
            }
        </div>

        <div class="col-lg-4">
            <div class="cart-summary">
                <div class="fw-bold mb-2">@Model?.Cart?.Lines.Count() ?? 0 s·∫£n ph·∫©m</div>
                <div class="fw-bold text-danger fs-5 mb-2">@Model?.Cart?.ComputeTotalValue().ToString("N0") ƒë</div>
                <p class="small text-muted mb-3">(Ch∆∞a c√≥ c∆∞·ªõc v·∫≠n chuy·ªÉn)</p>

                <form method="post" asp-page-handler="ProceedToCheckout">
                    <input type="hidden" name="returnUrl" value="@Model?.ReturnUrl" />
                    <button type="submit" class="btn btn-checkout w-100 btn-action">
                        TI·∫æN H√ÄNH ƒê·∫∂T H√ÄNG
                    </button>
                </form>

                <a href="@Model?.ReturnUrl" class="btn btn-update w-100 btn-action mt-2">
                    üèçÔ∏è TI·∫æP T·ª§C MUA H√ÄNG
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Modal Th√™m v√†o gi·ªè h√†ng -->
<div class="modal fade" id="addToCartModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content p-3">
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6 border-end">
                        <div class="text-success fw-bold mb-3">
                            <i class="fa fa-check-circle fa-lg"></i> 1 s·∫£n ph·∫©m v·ª´a ƒë∆∞·ª£c th√™m v√†o gi·ªè h√†ng
                        </div>
                        <div class="d-flex gap-3 align-items-start">
                            <img id="addedProductImage" src="/images/default.jpg" alt="S·∫£n ph·∫©m"
                                 style="width: 100px; height: 140px; object-fit: cover;" />
                            <div>
                                <div id="addedProductName" class="fw-semibold"></div>
                                <div id="addedProductDetails" class="small text-muted"></div>
                                <div class="fw-bold text-danger mt-2" id="addedProductPrice"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="fw-bold mb-2">Gi·ªè h√†ng (<span id="cartItemCount">0</span> s·∫£n ph·∫©m)</div>
                        <div>T·∫°m t√≠nh:</div>
                        <div class="fw-bold text-danger fs-5 mb-2" id="cartTotalPrice">0 ƒë</div>
                        <div class="d-flex gap-2">
                            <a href="@Model?.ReturnUrl" class="btn btn-outline-success flex-fill">‚Üê Ti·∫øp t·ª•c mua h√†ng</a>
                            <a href="/Cart" class="btn btn-success flex-fill">Thanh to√°n ‚Üí</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function showAddToCartModal(product) {
        document.getElementById("addedProductImage").src = "/images/" + (product.image || "default.jpg");
        document.getElementById("addedProductName").textContent = product.name;
        document.getElementById("addedProductDetails").textContent = product.details;
        document.getElementById("addedProductPrice").textContent = product.price + " ƒë";
        document.getElementById("cartItemCount").textContent = product.cartCount;
        document.getElementById("cartTotalPrice").textContent = product.cartTotal + " ƒë";
        var modal = new bootstrap.Modal(document.getElementById('addToCartModal'));
        modal.show();
    }

    document.addEventListener("DOMContentLoaded", function () {
        const params = new URLSearchParams(window.location.search);
        if (params.get("added") === "true") {
            showAddToCartModal({
                image: "@Model?.Cart?.Lines.LastOrDefault()?.Product.Image",
                name: "@Model?.Cart?.Lines.LastOrDefault()?.Product.Name",
                details: "@(Model?.Cart?.Lines.LastOrDefault()?.IsRental == true ? "Thu√™ " + Model?.Cart?.Lines.LastOrDefault()?.RentalDays + " ng√†y" : "Mua")",
                price: "@Model?.Cart?.Lines.LastOrDefault()?.LineTotal.ToString("N0")",
                cartCount: "@Model?.Cart?.Lines.Count()",
                cartTotal: "@Model?.Cart?.ComputeTotalValue().ToString("N0")"
            });
        }
    });
</script>
